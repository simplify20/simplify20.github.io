(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{510:function(t,s,a){"use strict";a.r(s);var n=a(4),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("center",[a("img",{staticStyle:{zoom:"70%"},attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90adfd662806475b922aa021332794c1~tplv-k3u1fbpfcp-zoom-1.image"}})]),t._v(" "),a("center",[t._v("生产流水线")]),t._v(" "),a("h3",{attrs:{id:"引子"}},[t._v("引子")]),t._v(" "),a("p",[t._v("在移动应用开发过程中，大部分时候不需要关心所写的代码是如何执行的，比如说，我们定义好一个UI组件，程序运行时它的渲染逻辑就会被执行，而如何触发它的执行对我们来说是透明的。在浏览器环境中，web应用可能做UI展示、设置事件监听、进行IO操作等，即使在单线程的javascript运行环境下，上述行为也能被及时响应，而不会block用户。")]),t._v("\n无论Web，还是移动应用，各种逻辑执行行为都可以可以泛化为任务，而这些行为的表现取决于任务的执行机制及任务调度机制。"),a("p"),t._v(" "),a("h3",{attrs:{id:"进程调度"}},[t._v("进程调度")]),t._v(" "),a("p",[t._v("再深入应用内的任务调度前，先放大视野，讲讲进程调度。在单任务操作系统中，每次只能运行一个程序，在多任务操作系统中，允许一到多个程序并发运行，并发运行是基于时间片(time slice)的：将CPU时间划分成一个个小段，然后将这些小段分配给进程。")]),t._v(" "),a("img",{attrs:{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ade9eaee32b24a43a255541409bfef1a~tplv-k3u1fbpfcp-watermark.image",alt:""}}),t._v("\n图("),a("a",{attrs:{href:"https://mp.weixin.qq.com/s/HJIVxnzyDesYPGGyJsaFyQ",target:"_blank",rel:"noopener noreferrer"}},[t._v("LieBrother"),a("OutboundLink")],1),t._v(")"),a("p"),t._v("\n如图，多个进程共享时间片。时间片的分配基于各种进程调度算法："),a("p"),t._v(" "),a("h4",{attrs:{id:"进程调度算法"}},[t._v("进程调度算法")]),t._v(" "),a("p",[a("strong",[t._v("FIFO(First In First Out)")])]),t._v("\n先进入队列的进程先运行，运行到完成或者阻塞时，再重新调度。这种算法一般会结合优先级进行调度"),a("p"),t._v(" "),a("p",[a("strong",[t._v("RR(Round Robin)")])]),t._v("\n按照进程到达时间轮流调度。"),a("p"),a("p"),t._v(" "),a("ul",[a("li",[t._v("1.进程在给定时间执行结束，进入2，否则将进程移动到队尾，进入2")]),t._v(" "),a("li",[t._v("2.下一个进程开始执行")]),t._v(" "),a("li",[t._v("3.重复1\n"),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3185ca31e6a643a1b817397933d5768b~tplv-k3u1fbpfcp-watermark.image",alt:""}}),t._v("\n图片("),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Round-robin_scheduling",target:"_blank",rel:"noopener noreferrer"}},[t._v("wikipedia"),a("OutboundLink")],1),t._v(")")])]),t._v(" "),a("p",[a("strong",[t._v("SPN(Shortest Job Next)")])]),t._v("\n最短进程优先。将预期占用运行时间最短的进程优先执行，直到运行完成或阻塞时，再重新调度。"),a("p"),t._v(" "),a("p",[a("strong",[t._v("SRT(Shortest Remaining Time)")])]),t._v("\n最短剩余时间优先。新进程进来时，如果新进程的预计运行时间比当前进程的剩余运行时间更短，就抢占当前进程"),a("p"),t._v(" "),a("h4",{attrs:{id:"android的进程调度"}},[t._v("Android的进程调度")]),t._v(" "),a("p",[a("strong",[t._v("OOM_ADJ")])]),a("p"),t._v(" "),a("ul",[a("li",[t._v("oom_score_adj"),a("p"),t._v("\n每个运行的进程都有一个"),a("code",[t._v("/proc/[pid]/oom_score_adj")]),t._v("文件，这个文件允许的值的范围是："),a("code",[t._v("-1000 ~ +1000")]),t._v("之间。"),a("strong",[t._v("值越小，表示进程越重要")]),t._v("。\n当内存非常紧张时，系统便会遍历所有进程，以确定哪个进程需要被杀死以回收内存，此时便会读取oom_score_adj 这个文件的值"),a("p")])]),t._v(" "),a("p",[t._v("在Android中，每个进程都有一个ProcessRecord与之对应\n"),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95153424efc04a8fb70746f932d0430f~tplv-k3u1fbpfcp-zoom-1.image",alt:""}}),t._v("\n图片("),a("a",{attrs:{href:"https://paul.pub/android-process-priority/#id-%E4%BC%98%E5%85%88%E7%BA%A7%E7%9A%84%E4%BE%9D%E6%8D%AE",target:"_blank",rel:"noopener noreferrer"}},[t._v("Paul"),a("OutboundLink")],1),t._v(")")]),t._v(" "),a("p",[t._v("ProcessRecord的以下属性值与OOM调整值相关：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" maxAdj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Maximum OOM adjustment for this process")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" curRawAdj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Current OOM unlimited adjustment for this process")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" setRawAdj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("              "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Last set OOM unlimited adjustment for this process")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" curAdj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Current OOM adjustment for this process")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" setAdj"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Last set OOM adjustment for this process")]),t._v("\n")])])]),a("p",[t._v("oomAdj可取的常量定义如下：")]),t._v(" "),a("code",[t._v("ProcessList.java")]),a("p"),a("p"),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" UNKNOWN_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1001")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 未知进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PREVIOUS_APP_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("700")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 前一个应用")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" HOME_APP_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("600")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 桌面进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" SERVICE_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 包含了Service的进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" HEAVY_WEIGHT_APP_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("400")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重量级进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" BACKUP_APP_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("300")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 备份应用进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PERCEPTIBLE_APP_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 可感知的进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" VISIBLE_APP_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 可见进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" VISIBLE_APP_LAYER_MAX "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" PERCEPTIBLE_APP_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" VISIBLE_APP_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" FOREGROUND_APP_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 前台进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PERSISTENT_SERVICE_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("700")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 常驻服务进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PERSISTENT_PROC_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("800")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 常驻应用进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" SYSTEM_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("900")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 系统进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" NATIVE_ADJ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// native系统进程")]),t._v("\n")])])]),a("p",[a("strong",[t._v("这个优先级反映了Android系统进程重要性的判定")]),t._v("，Android系统认为“重要”的进程主要有三类：")]),t._v(" "),a("ul",[a("li",[t._v("系统进程")]),t._v(" "),a("li",[t._v("前台与用户有交互的进程")]),t._v(" "),a("li",[t._v("前台进程所使用到的进程(bound ContentProviders/Services)")])]),t._v(" "),a("p",[t._v("这个重要性提现了Android系统"),a("strong",[t._v("以与的用户交互程度和感知度")]),t._v("为依据的优先级设定，与用户发生交互的前台进程优先级大于无交互仅可见的进程，而可见进程的优先级又大于可感知进程，可感知进程优先级又大于无感知的服务进程。")]),t._v(" "),a("p",[a("strong",[t._v("SchedGroup")])]),t._v("\nAndroid中通过SchedGroup标志进程的调度组，AMS会根据进程的状态来设置调度组"),a("p"),t._v(" "),a("code",[t._v("ProcessRecord.java")]),a("p"),a("p"),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" curSchedGroup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Currently desired scheduling class")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" setSchedGroup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Last set to background scheduling class")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" curProcState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Currently computed process state")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" repProcState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Last reported process state")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" setProcState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Last set process state in process tracker")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" pssProcState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Currently requesting pss for")]),t._v("\n")])])]),a("p",[t._v("常量定义如下：")]),t._v(" "),a("code",[t._v("ProcessList.java")]),a("p"),a("p"),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Activity manager's version of Process.THREAD_GROUP_BG_NONINTERACTIVE")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" SCHED_GROUP_BACKGROUND "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Activity manager's version of Process.THREAD_GROUP_DEFAULT")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" SCHED_GROUP_DEFAULT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Activity manager's version of Process.THREAD_GROUP_TOP_APP")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" SCHED_GROUP_TOP_APP "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Activity manager's version of Process.THREAD_GROUP_TOP_APP")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Disambiguate between actual top app and processes bound to the top app")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" SCHED_GROUP_TOP_APP_BOUND "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[a("code",[t._v("ActivityManager.java")])]),a("p"),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_NONEXISTENT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_PERSISTENT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_PERSISTENT_UI "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_TOP "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_BOUND_FOREGROUND_SERVICE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_FOREGROUND_SERVICE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_TOP_SLEEPING "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_IMPORTANT_FOREGROUND "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_IMPORTANT_BACKGROUND "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_BACKUP "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_HEAVY_WEIGHT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_SERVICE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_RECEIVER "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_HOME "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_LAST_ACTIVITY "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_CACHED_ACTIVITY "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_CACHED_ACTIVITY_CLIENT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" PROCESS_STATE_CACHED_EMPTY "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[a("strong",[t._v("Android的进程调度策略")])]),t._v(" "),a("blockquote",[a("p",[t._v("Android基于Linux内核，在目前的Linux内核中，一共有六种调度策略，它们可以分为三类：")]),t._v(" "),a("ul",[a("li",[t._v("普通调度策略：SCHED_NORMAL, SCHED_BATCH，SCHED_IDLE 。")]),t._v(" "),a("li",[t._v("实时调度策略：SCHED_FIFO, SCHED_RR。")]),t._v(" "),a("li",[t._v("Deadline调度策略：SCHED_DEADLINE。")])])]),t._v(" "),a("ul",[a("li",[a("p",[a("strong",[t._v("SCHED_NORMA")]),t._v(" 是进程默认调度策略")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("SCHED_BATCH")]),t._v(" 与SCHED_NORMAL类似，不同的是，内核会认为该进程是CPU密集型，因此在调度会有小的惩罚。这种策略适用于那些非交互的后台进程")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("SCHED_IDLE")]),t._v(" 优先级最低的调度策略")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("SCHED_FIFO/SCHED_RR")]),t._v(" 就是我们前面提到过FIFO和RR调度算法")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("SCHED_DEADLINE")]),t._v(" 指定了预计完成时间的调度策略，它拥有超过所有其他策略的最高优先级")])])]),t._v(" "),a("p",[t._v("总体优先级顺序：SCHED_DEADLINE > SCHED_FIFO = SCHED_RR > SCHED_NORMAL > SCHED_BATCH > SCHED_IDLE")]),t._v(" "),a("p",[a("strong",[t._v("cgroup")])]),t._v(" "),a("p",[t._v("cgroup是control group的缩写。这是一个Linux内核的特性。用来对进程所使用的资源（如CPU、内存、磁盘输入输出等）进行限制、统计与隔离。")]),t._v(" "),a("p",[t._v("通过cgroup可以配置不同类型进程的cpusets")]),t._v(" "),a("p",[a("code",[t._v("init.rc")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),t._v(" /dev/cpuset/top-app/cpus "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("-3\n "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),t._v(" /dev/cpuset/foreground/cpus "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("-2\n "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),t._v(" /dev/cpuset/background/cpus "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),t._v(" /dev/cpuset/system-background/cpus "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("-2\n "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),t._v(" /dev/cpuset/restricted/cpus "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("-1\n\n")])])]),a("p",[t._v("根据以上配置，在四核手机上：top-app进程可以使用所有cpu，foreground进程可以使用三个cpu")]),t._v(" "),a("p",[a("strong",[t._v("Process类")])]),t._v(" "),a("p",[t._v("在Android中可以通过Process类设置进程（线程）的调度器和优先级")]),t._v(" "),a("p",[a("strong",[t._v("AMS")])]),t._v(" "),a("p",[t._v("在Android中，AMS负责应用的进程管理。在根据进程分类、进程状态等因素，把oomAdj值及调度组计算好以后，AMS会调用applyOomAdjLocked，应用不同的进程调度策略和优先级")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setProcessGroup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" processGroup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("curSchedGroup "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProcessList")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SCHED_GROUP_TOP_APP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do nothing if we already switched to RT")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("oldSchedGroup "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ProcessList")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SCHED_GROUP_TOP_APP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        mVrController"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onTopProcChangedLocked")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mUseFifoUiScheduling"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Switch UI pipeline for app to SCHED_FIFO")]),t._v("\n            app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("savedPriority "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Process")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getThreadPriority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleAsFifoPriority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* suppressLogs */")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("renderThreadTid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("scheduleAsFifoPriority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("renderThreadTid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* suppressLogs */")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DEBUG_OOM_ADJ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Slog")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("d")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UI_FIFO"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Set RenderThread (TID "')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n                        app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("renderThreadTid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('") to FIFO"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DEBUG_OOM_ADJ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Slog")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("d")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UI_FIFO"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Not setting RenderThread TID"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Boost priority for top app UI and render threads")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setThreadPriority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TOP_APP_PRIORITY_BOOST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("renderThreadTid "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setThreadPriority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("renderThreadTid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                            TOP_APP_PRIORITY_BOOST"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("IllegalArgumentException")]),t._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// thread died, ignore")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n")])])]),a("p",[t._v("调用链：")]),t._v(" "),a("p",[t._v("Process.java->android_util_Process.cpp->libprocessgroup")]),t._v(" "),a("h4",{attrs:{id:"android的进程调度总结"}},[t._v("Android的进程调度总结")]),t._v(" "),a("p",[t._v("Android进程调度是基于优先级的，而这个优先级取决于Andrid系统对进程重要性的判定，系统进程是最核心的进程，是所有应用进程的依托，而应用进程的重要性，取决于"),a("strong",[t._v("用户的交互程度和感知度")]),t._v("，这个是在设计交互应用时要考虑的，对于进程和线程的优先级，前台>后台，交互>非交互，感知>非感知，系统>应用。")]),t._v(" "),a("p",[t._v("此外，用户的交互行为，例如切换应用、启动应用，杀死应用，锁屏等，导致Android进程的状态也处于动态的变化中，需要根据不同进程状态设置不同的优先级，以快速响应用户或者节省资源。")]),t._v(" "),a("p",[t._v("关于进程调度的介绍就到此为止，更多内容可以参考"),a("a",{attrs:{href:"https://paul.pub/android-process-schedule/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Android系统上的进程管理：进程的调度"),a("OutboundLink")],1),t._v(",以及"),a("a",{attrs:{href:"https://paul.pub/android-process-priority/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Android系统中的进程管理：进程的优先级"),a("OutboundLink")],1),t._v("\n。这里有很多内容，参考了上面的文章，鸣谢！")]),t._v(" "),a("p",[t._v("接下来，我将会缩小视野，聊一聊"),a("strong",[t._v("进程内（应用内）的任务调度")]),t._v("，而无论是进程调度还是进程内的任务调度，都是"),a("strong",[t._v("利用有限的计算资源，以最快的响应速度，并以一定策略完成一项或者多项工作")]),t._v("。下面将介绍如何在应用中并行或串行地完成多项任务。")]),t._v(" "),a("h3",{attrs:{id:"并发模型"}},[t._v("并发模型")]),t._v(" "),a("p",[a("strong",[t._v("设计模式")]),t._v("指导我们如何设计高可扩展、高可维护的代码，而"),a("strong",[t._v("并发模型")]),t._v("指导我们如何设计高效、安全的"),a("strong",[t._v("多任务执行器(调度器)")]),t._v("。")]),t._v(" "),a("h4",{attrs:{id:"并行工作器-parallel-workers"}},[t._v("并行工作器(Parallel Workers)")]),t._v(" "),a("p",[t._v("任务被提交到一系列并行工作的Worker中，这些worker工作在不同的线程(CPU)上，无法保证任务的执行顺序。java的"),a("strong",[t._v("ThreadPoolExecutor")]),t._v("就使用了这个模型")]),t._v(" "),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2115db9148cb4afeb0e7408d9c842445~tplv-k3u1fbpfcp-watermark.image",alt:""}}),a("p"),t._v(" "),a("p",[t._v("图片"),a("a",{attrs:{href:"http://tutorials.jenkov.com/java-concurrency/concurrency-models.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jenkov Aps"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("并行工作的Worker往往需要共享状态（内存或者数据库），ThreadPoolExecutor中不同Worker共享一个任务队列。当存在共享状态时，就可能存在竞态条件和死锁，程序也会变得复杂。Worker等待别的Worker完成共享状态的访问时，并行运行机制可能退化为串行工作机制。\n"),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/203fd3f235e841eba2be899d487da667~tplv-k3u1fbpfcp-zoom-1.image",alt:""}}),t._v(" "),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c3c1f8d44f64489ba2bfdf7243481ca0~tplv-k3u1fbpfcp-zoom-1.image",alt:""}})]),t._v(" "),a("p",[t._v("图片"),a("a",{attrs:{href:"http://tutorials.jenkov.com/java-concurrency/concurrency-models.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jenkov Aps"),a("OutboundLink")],1)]),t._v(" "),a("h4",{attrs:{id:"流水线工作器-reactive-event-driven-model"}},[t._v("流水线工作器(Reactive,Event Driven Model)")]),t._v(" "),a("p",[t._v("一系列Worker分布在流水线上，这些Worker工作在不同线程，之间"),a("strong",[t._v("不共享内存")]),t._v("，每个Worker只处理整个工作的一部分，Worker完成了自己的那一部分，将工作交给下个Worker，该模型的好处是可以实现有顺序的工作流程，"),a("strong",[t._v("不共享内存")]),t._v("避免了"),a("strong",[t._v("并行工作器")]),t._v("模型中存在的"),a("strong",[t._v("多线程资源竞争问题(race condition)")]),t._v(" 以及复杂性")]),t._v(" "),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8eb1ee2551a43cd8c06d6d784a894fe~tplv-k3u1fbpfcp-zoom-1.image",alt:"An image"}}),t._v(" "),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/94f9287d4611463491d98d64b8e11df6~tplv-k3u1fbpfcp-zoom-1.image",alt:"An image"}}),a("p"),t._v(" "),a("p",[t._v("图片"),a("a",{attrs:{href:"http://tutorials.jenkov.com/java-concurrency/concurrency-models.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jenkov Aps"),a("OutboundLink")],1)]),t._v(" "),a("h4",{attrs:{id:"actor模型-event-driven-model"}},[t._v("Actor模型(Event Driven Model)")]),t._v(" "),a("p",[t._v("在Actor模型中，每个Worker称之为Actor，Actor之间可以相互发消息，消息的发送和处理都是异步的，Actor模型可以处理一项或者多项工作")]),t._v(" "),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6acd289d84854d2296bb293be9d62af4~tplv-k3u1fbpfcp-zoom-1.image",alt:"An image"}}),t._v(" "),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ed7bd7c5130248d4aa1f00c31b04ff90~tplv-k3u1fbpfcp-zoom-1.image",alt:"An image"}}),a("p"),t._v(" "),a("p",[t._v("图片"),a("a",{attrs:{href:"http://tutorials.jenkov.com/java-concurrency/concurrency-models.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jenkov Aps"),a("OutboundLink")],1)]),t._v(" "),a("h4",{attrs:{id:"channel模型-event-driven-model-csp模型"}},[t._v("Channel模型(Event Driven Model/CSP模型)")]),t._v(" "),a("p",[t._v("在Channel模型中，Worker之间不直接通信，而是通过向Channel发消息和接收消息通信，Worker之间是解耦的。"),a("strong",[t._v("golang协程")]),t._v("和"),a("strong",[t._v("kotlin协程")]),t._v("都采用了这种模型")]),t._v(" "),a("img",{attrs:{src:"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/281b69ae38384967bcc86c79f9f90010~tplv-k3u1fbpfcp-watermark.image",alt:""}}),a("p"),t._v(" "),a("p",[t._v("图片"),a("a",{attrs:{href:"http://tutorials.jenkov.com/java-concurrency/concurrency-models.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jenkov Aps"),a("OutboundLink")],1)]),t._v(" "),a("h4",{attrs:{id:"函数式并发模型-functional-parallelism"}},[t._v("函数式并发模型(Functional Parallelism)")]),t._v(" "),a("p",[t._v("该模型认为一项工作可以由一系列函数调用完成，函数被视为Actor，一个函数调用另一个函数视为发送消息，传递到函数的参数是拷贝的，不存在被修改的情况，每个函数可以被独立地执行，java的"),a("strong",[t._v("ForkAndJoinPool")]),t._v("实现了这种机制")]),t._v(" "),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56124f47d19b48508a0145db9d6ea839~tplv-k3u1fbpfcp-zoom-1.image",alt:""}}),a("p"),t._v(" "),a("p",[t._v("图片"),a("a",{attrs:{href:"https://blog.csdn.net/permike/article/details/109820881",target:"_blank",rel:"noopener noreferrer"}},[t._v("permike"),a("OutboundLink")],1)]),t._v(" "),a("h4",{attrs:{id:"并发模型总结"}},[t._v("并发模型总结")]),t._v(" "),a("p",[t._v("生产流水线是在现实生活中可以看到的并发实例，不同的"),a("strong",[t._v("工人(机器)")]),t._v(" 分布于流水线的不同环节，完成各自既定的"),a("strong",[t._v("工序")]),t._v("，如开篇图那样，每个工人完成自己的工序后，开始处理下一件产品，完成工序的产品通过传送带传到下一个工人，执行下一步工序。生产流水线对应到并发模型中就是"),a("strong",[t._v("流水线模型")]),t._v(" ，每个工人之间存放正在传送的产品的空间可以称之为"),a("strong",[t._v("Buffer")]),t._v("，有了这个Buffer，工人之间即使完成工序的速度不平衡，也不会出现一个工人处理不过来，一个工人没有产品可以处理的情况。")]),t._v(" "),a("p",[t._v("通过发消息发送任务请求，接收消息去处理任务的场景很多，例如"),a("strong",[t._v("分布式系统")]),t._v("、Android中的"),a("strong",[t._v("Handler")]),t._v("等，对应到并发模型，就是"),a("strong",[t._v("Actor模型")])]),t._v(" "),a("p",[t._v("下面将介绍一种计算机软件中随处可见的任务执行模型："),a("strong",[t._v("事件循环模型")]),t._v("，可以看到，它是"),a("strong",[t._v("Actor模型")]),t._v("的一种特例")]),t._v(" "),a("h3",{attrs:{id:"事件循环-event-loop"}},[t._v("事件循环（Event Loop）")]),t._v(" "),a("p",[t._v("除了并发式的任务执行，还有一种常见的执行方式称之为"),a("strong",[t._v("事件循环")]),t._v("：")]),t._v(" "),a("blockquote",[a("p",[t._v("事件循环是一种程序设计结构，这种结构会等待消息，并分发消息给消息处理器去处理（wikipedia)")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1607270613397&di=e7969025d1307312ab92c96d2cddb949&imgtype=0&src=http%3A%2F%2Fimg3.imgtn.bdimg.com%2Fit%2Fu%3D3108086878%2C3587553376%26fm%3D214%26gp%3D0.jpg",alt:"An image"}})]),t._v(" "),a("p",[t._v("事件循环的伪代码如下：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" main\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("initialize")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" message "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" quit\n        message "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get_next_message")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("process_message")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    end "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v("\nend "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v("\n")])])]),a("p",[t._v("Android、iOS、Windows、javascript(浏览器)、Node.js主线程都采用了这种运行模式")]),t._v(" "),a("h4",{attrs:{id:"event-loop-in-android"}},[t._v("Event Loop in Android")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf00c22bf0cd4f098c18f49980bdebb3~tplv-k3u1fbpfcp-zoom-1.image",alt:"Image"}})]),t._v(" "),a("p",[t._v("为便于理解，去掉了部分代码：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("loop")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Looper")]),t._v(" me "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("myLooper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MessageQueue")]),t._v(" queue "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" me"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mQueue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//1.循环")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//2.从消息队列取消息")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Message")]),t._v(" msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" queue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// might block")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3.退出逻辑")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//4.分发消息")]),t._v("\n            msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("target"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatchMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("消息分发：\n"),a("img",{attrs:{src:"https://miro.medium.com/max/1400/1*rvIs3RCqJw1WFwuHwMtgaQ.png",alt:""}}),t._v("\nMessageQueue利用了linux的"),a("strong",[t._v("epoll")]),t._v("机制：在消息队列为空或者消息没到执行时间时，释放CPU，避免不必要的资源浪费（"),a("strong",[t._v("忙等")]),t._v("会浪费CPU)，从消息队列取消息的逻辑(为便于理解，去掉了部分代码)：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Message")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" ptr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mPtr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//该方法可能会阻塞主线程")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1.nextPollTimeoutMillis>0：队列头部的消息，执行时间还没到，有限时阻塞，如果消息队列没有消息写入，nextPollTimeoutMillis时间后该方法返回，否则有消息写入时该方法返回")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2.nextPollTimeoutMillis<0：消息队列为空，无限时阻塞，有消息写入时该方法返回")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3.nextPollTimeoutMillis=0：不阻塞，立即返回")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nativePollOnce")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ptr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" nextPollTimeoutMillis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Message")]),t._v(" msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mMessages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("now "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("when"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Next message is not ready.  Set a timeout to wake up when it is ready.")]),t._v("\n                    nextPollTimeoutMillis "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Math")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("min")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("when "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Integer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MAX_VALUE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Got a message.")]),t._v("\n                    mBlocked "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prevMsg "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                        prevMsg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                        mMessages "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n                    msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("next "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DEBUG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("v")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Returning message: "')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n                    msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("markInUse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// No more messages.")]),t._v("\n                nextPollTimeoutMillis "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("在Android中，通过Looper可以快速地创建一个EventLoop，通过handler可以向其消息队列中发消息，随后，消息的处理将发生于EventLoopThread中:")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[t._v("    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("EventLoopThread")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//收发消息")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Handler")]),t._v(" handler"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Looper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("prepare")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            handler "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Handler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Looper")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("loop")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"event-loop-in-node-js"}},[t._v("Event Loop in Node.js:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f42ff9d120f84ff7892844d2184a8f45~tplv-k3u1fbpfcp-zoom-1.image",alt:"An image"}})]),t._v(" "),a("h4",{attrs:{id:"event-loop-in-browser"}},[t._v("Event Loop in Browser:")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3d9e1edee7f145d293ecb7deca09fa0c~tplv-k3u1fbpfcp-zoom-1.image",alt:"An image"}})]),t._v(" "),a("h4",{attrs:{id:"event-loop总结"}},[t._v("Event Loop总结")]),t._v(" "),a("p",[t._v("\bEvent Loop模型多用于UI应用中，UI应用需要不断地响应用户的"),a("strong",[t._v("输入事件")]),t._v("，以一定频率不断"),a("strong",[t._v("刷新UI界面")]),t._v("，这些操作可以通过Event Loop完成，当用户输入事件发生或者UI刷新信号到达时，向消息队列中添加相应的消息，Event Loop取出消息，执行相应回调或者执行UI渲染指令即可。")]),t._v(" "),a("p",[t._v("\bEvent Loop模型也用于C/S通信模型")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2bfb7e1d1e4c47cf97464d54a8e7ade9~tplv-k3u1fbpfcp-watermark.image"}}),t._v(" "),a("p",[a("strong",[t._v("Zygote")]),t._v("采用了Event Loop方式监听Socket，收到"),a("strong",[t._v("AMS")]),t._v("发出的创建新进程的消息后，孵化出新的应用进程")]),t._v(" "),a("p",[a("code",[t._v("ZygoteInit.java")])]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" argv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("registerZygoteSocket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("socketName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("runSelectLoop")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("abiList"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("closeServerSocket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("不同任务对硬件有不同的需要，按照任务对CPU、IO速度要求的不同可以分为"),a("strong",[t._v("CPU密集型和IO密集型")])]),t._v(" "),a("h3",{attrs:{id:"cpu密集型、io密集型-cpu-bound-io-bound"}},[t._v("CPU密集型、IO密集型（CPU-bound/IO-bound）")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("如果CPU更快或者有更多的CPU，任务执行的会更快，这样的任务是CPU密集型任务，任务主要的时间在使用CPU（做计算）")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("视频编解码、圆周率计算、CG渲染等")])])])]),t._v(" "),a("li",[a("p",[t._v("如果IO速度更快，任务执行的会更快，这样的任务是IO密集型任务，任务主要的时间在等IO")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("网络请求、磁盘读写等")])])])])]),t._v(" "),a("p",[t._v("了解任务的分类后，我们知道，如果将一个IO密集型的任务和一个CPU密集型的任务放到"),a("strong",[t._v("流水线模型")]),t._v("中会存在这样\b的问题：IO密集型任务等待IO的过程中，下一个环节的CPU密集型任务无法执行。下面将介绍的"),a("strong",[t._v("IO模型")]),t._v("将解答这个问题。")]),t._v(" "),a("h3",{attrs:{id:"io模型"}},[t._v("IO模型")]),t._v(" "),a("p",[a("strong",[t._v("阻塞IO(BIO)")])]),t._v(" "),a("p",[t._v("IO操作后，内核返回结果前应用程序处于阻塞状态")]),t._v(" "),a("p",[a("strong",[t._v("非阻塞IO(NIO)")])]),t._v(" "),a("p",[t._v("IO操作后，内核马上返回结果，需要轮询查IO结果")]),t._v(" "),a("p",[a("strong",[t._v("多路复用IO")])]),t._v(" "),a("p",[t._v("同时等待多个i/o通道的数据：select/poll/epoll")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ba1ea686c95649389b16793d7e0220dd~tplv-k3u1fbpfcp-watermark.image",alt:""}}),t._v("\nepoll相较于select/poll，多了两次系统调用，其中epoll_create建立与内核的连接，epoll_ctl注册事件，epoll_wait阻塞用户进程，等待IO事件。")]),t._v(" "),a("p",[a("strong",[t._v("异步IO(AIO)")])]),t._v(" "),a("p",[t._v("用户进程发出IO系统调用后立即返回，内核等待数据准备完成，然后将数据拷贝到用户进程缓冲区，然后发送信号告诉用户进程IO操作执行完毕")]),t._v(" "),a("p",[a("strong",[t._v("同步IO")])]),t._v(" "),a("p",[t._v("阻塞IO、非阻塞IO、多路复用IO均为同步IO")]),t._v(" "),a("p",[a("strong",[t._v("IO模型总结")])]),t._v(" "),a("p",[t._v("javascript是单线程的，如果执行过程涉及很多"),a("strong",[t._v("同步IO操作")]),t._v("是否就会存在以下问题：\n"),a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ebd0d555d4ee4d2eabb8e9c8e11feeb0~tplv-k3u1fbpfcp-zoom-1.image",alt:"An image"}})]),t._v("\n上图的绿色部分是程序的运行时间，红色部分是等待时间。从事实上看并不会这样。为了解决上述问题，javascript使用了上面提到过的Event Loop程序执行机制"),a("p"),a("p"),t._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbc1f4248009421083a3521011723393~tplv-k3u1fbpfcp-zoom-1.image",alt:"An image"}})]),t._v('\n上图中，主线程运行的时候，产生堆（heap）和栈（stack），栈中的代码调用各种外部API，它们在"任务队列"中加入各种事件（click，load，done）。只要栈中的代码执行完毕，主线程就会去读取"任务队列"，依次执行那些事件所对应的回调函数。javascript中，'),a("strong",[t._v("同步IO操作")]),t._v("被放到单独的线程中执行，执行完毕后向任务队列中加入相应的回调，主线程读取到任务队列中相应的回调，并执行，一次IO结束，这样就避免了同步IO对主线程的阻塞问题。"),a("p"),t._v(" "),a("h3",{attrs:{id:"总结"}},[t._v("总结")]),t._v(" "),a("p",[t._v("本篇文章以”应用中如何完成一件事“为题，标题比较宽泛，本质上讲，每行代码的执行都是应用在完成一件事，我所指的”事“侧重于"),a("strong",[t._v("任务(task)")]),t._v("，或者一个"),a("strong",[t._v("代码执行单元")]),t._v("。首先从"),a("strong",[t._v("进程")]),t._v("这个”大任务“出发，视野逐渐缩小，逐渐深入到一个"),a("strong",[t._v("callback、runnable、microtask")]),t._v("的执行。无论是前者还是后者，运行时都需要cpu和内存资源。")]),t._v(" "),a("p",[t._v("在进程视野，操作系统会将进程分类，并使用不同的"),a("strong",[t._v("调度策略和优先级")]),t._v("，操作系统在保证系统服务运行资源足够的前提下，与用户有"),a("strong",[t._v("交互行为")]),t._v("的进程在资源分配上将会侧重。操作系统是"),a("strong",[t._v("面向用户，为用户提供服务")]),t._v("的，这种侧重无疑体现了这一点。")]),t._v(" "),a("p",[t._v("再缩小到应用视野，每个应用至少有一个进程与之对应，"),a("strong",[t._v("每个进程可能运行着一到多个线程")]),t._v("，为了充分利用CPU资源，实现多个"),a("strong",[t._v("任务的并发")]),t._v("，需要根据业务场景，结合"),a("strong",[t._v("并发模式")]),t._v("设计不同的并发程序，以达到最大的任务吞吐量，同时避免不必要的"),a("em",[t._v("复杂度")]),t._v("和"),a("em",[t._v("资源浪费")]),t._v("，"),a("strong",[t._v("并行工作器")]),t._v("在java中被广泛的使用，"),a("strong",[t._v("Actor模型")]),t._v("中的特例"),a("strong",[t._v("事件循环模型")]),t._v("在UI应用和C/S架构中被广泛使用。")]),t._v(" "),a("p",[t._v("和后台应用不同，UI应用大部分时间都是在主线程做事，使用多线程一般出于以下几个目的：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("优化资源利用")]),t._v("：等IO时，CPU是空闲状态，可以做更多事")]),t._v(" "),a("li",[a("strong",[t._v("一些情况下简化程序设计")]),t._v("：读和处理分开")]),t._v(" "),a("li",[a("strong",[t._v("快速响应")]),t._v("：不阻塞UI线程")])]),t._v(" "),a("p",[a("strong",[t._v("golang协程")]),t._v("，在操作系统进程（线程）调度机制的基础上，进行了扩展，实现了更强的多任务执行能力")]),t._v(" "),a("img",{staticStyle:{zoom:"40%"},attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a09d3c6cbb74fe49e6ee8367217ec6f~tplv-k3u1fbpfcp-watermark.image"}}),t._v(" "),a("p",[t._v("图 "),a("a",{attrs:{href:"https://mp.weixin.qq.com/s/c0l-6hcXFACHtS6U57LPqQ",target:"_blank",rel:"noopener noreferrer"}},[t._v("陈Qiu凯"),a("OutboundLink")],1),t._v("：Go Runtime的M-P-G模型")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("M")]),t._v("：Machine，对应"),a("strong",[t._v("OS线程")]),t._v("的概念，OS线程是CPU的最小调度单元，由内核调度模块负责调度。一般Runtime会限制同时运行"),a("strong",[t._v("M（阻塞的M另算）的数量与CPU核数（逻辑核）相同")]),t._v("，这样可以减少OS级别的上下文切换，大部分都切换都在用户态完成。")]),t._v(" "),a("li",[a("strong",[t._v("P")]),t._v("：Process，虚拟处理器的概念，一般一个逻辑核分配一个P，负责本逻辑核上的goroutine调度，"),a("strong",[t._v("解决全局共享队列的锁竞争问题")]),t._v("。M与P互相关联，M不能独立于P存在。")]),t._v(" "),a("li",[a("strong",[t._v("G")]),t._v("：Goroutine，"),a("strong",[t._v("用户态协程")]),t._v("，执行用户代码的实体，维护了堆栈与状态相关的信息，并分配了很小的栈空间（通常2KB）。")])]),t._v(" "),a("p",[t._v("Go Runtime的调度模式：")]),t._v(" "),a("ul",[a("li",[t._v("Go Runtime有两种Work队列："),a("strong",[t._v("LRQ")]),t._v("(local runnable queue)和"),a("strong",[t._v("GRQ")]),t._v("(global runnable queue),并利用了"),a("strong",[t._v("Work-Stealing")]),t._v("策略，在某一LRQ为空时从其他LRQ或者GRQ中取一半的任务执行")]),t._v(" "),a("li",[t._v("当陷入"),a("strong",[t._v("系统调用或者同步IO调用")]),t._v("时，M与P会暂时解绑，P会创建一个新的M,即创建一个新的线程，将新到达的G分配给新M执行")]),t._v(" "),a("li",[t._v("当进入"),a("strong",[t._v("异步IO")]),t._v("调用，阻塞的G会进入"),a("strong",[t._v("network poller")]),t._v(",而M则继续服务其他的G，在Linux平台，network poller实际上是对"),a("strong",[t._v("epoll")]),t._v("的封装，注册阻塞的fd并监听到达的事件，就绪的fd所在的G就会被重新调度，回到原来的LRQ等待被执行。当异步IO有结果时，阻塞的G重新进入LRQ")])]),t._v(" "),a("p",[t._v("这就是Go Runtime的高效调度模型，可以做到“无间断执行代码”！")]),t._v(" "),a("p",[t._v("后续在开发中结合这些知识，可以针对具体业务场景，选择合理的调度策略和优先级，毕竟操作系统资源有限，每个进程都是操作系统的公民，"),a("strong",[t._v("nice值")]),t._v("应该高一点。在一些场景中，如果现有的库或框架无法满足需求，可以尝试自定义"),a("strong",[t._v("任务调度器（执行器）")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"参考"}},[t._v("参考")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/c0l-6hcXFACHtS6U57LPqQ",target:"_blank",rel:"noopener noreferrer"}},[t._v("陈Qiu凯：等待的艺术：从Spin Lock到Token Bucket算法\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/HJIVxnzyDesYPGGyJsaFyQ",target:"_blank",rel:"noopener noreferrer"}},[t._v("LieBrother：进程知多少？\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://paul.pub/android-process-schedule/",target:"_blank",rel:"noopener noreferrer"}},[t._v("强波：Android系统上的进程管理：进程的调度\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://paul.pub/android-process-priority/",target:"_blank",rel:"noopener noreferrer"}},[t._v("强波：Android系统中的进程管理：进程的优先级\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://paul.pub/android-process-creation/",target:"_blank",rel:"noopener noreferrer"}},[t._v("强波：Android系统中的进程管理：进程的创建\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"http://tutorials.jenkov.com/java-concurrency/concurrency-models.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jenkov Aps：Concurrency Models\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://promisesaplus.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Promises/A+：Promises/A+\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/permike/article/details/109820881",target:"_blank",rel:"noopener noreferrer"}},[t._v("permike：常见的并发模型\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.cnblogs.com/sheng-jie/p/how-much-you-know-about-io-models.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("圣杰：IO 模型知多少 | 理论篇\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://stackoverflow.com/questions/868568/what-do-the-terms-cpu-bound-and-i-o-bound-mean",target:"_blank",rel:"noopener noreferrer"}},[t._v("unwind：What do the terms “CPU bound” and “I/O bound” mean?\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Round-robin_scheduling",target:"_blank",rel:"noopener noreferrer"}},[t._v("Wikipedia：Round-robin scheduling\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/Innost/article/details/90633199",target:"_blank",rel:"noopener noreferrer"}},[t._v("阿拉神农：线程和IO模型的极简知识\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Event_loop",target:"_blank",rel:"noopener noreferrer"}},[t._v("Wikipedia：Event loop\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2013/10/event_loop.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("阮一峰：什么是 Event Loop？\n"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.ruanyifeng.com/blog/2014/10/event-loop.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("阮一峰：JavaScript 运行机制详解：再谈Event Loop\n"),a("OutboundLink")],1)])],1)}),[],!1,null,null,null);s.default=e.exports}}]);